# F004 - 使用者登入功能

**狀態:** 已完成  
**優先級:** 高  
**預計完成日期:** 已完成  
**負責人:** 開發團隊

## 1. 功能概述

提供使用者登入系統的功能，支援不同角色（管理員、經理、教師、學生）的身份驗證，並根據角色提供適當的權限和功能訪問。

## 2. 需求規格

### 2.1 功能需求

- 提供電子郵件和密碼登入功能
- 支援記住登入狀態功能
- 根據不同用戶角色展示不同的功能選項
- 提供登出功能，清除所有相關的會話資訊
- 支援權限控制，限制特定功能只能由特定角色訪問
- 使用 JWT Token 進行身份驗證和授權

### 2.2 相關需求文檔

- 前端登入邏輯實現在 `src/components/LoginDialog.vue`
- 用戶狀態管理在 `src/stores/user.js`
- API 相關處理在 `src/apis/authorizationApi.js`

## 3. 使用者故事

**作為** 系統使用者，  
**我希望** 能夠使用我的電子郵件和密碼登入系統，  
**以便** 訪問與我角色相關的功能和資訊。

**作為** 管理員，  
**我希望** 系統能根據我的角色提供管理功能，  
**以便** 我可以管理課程、使用者和系統設定。

**作為** 學生，  
**我希望** 只看到與我相關的課程和功能，  
**以便** 我可以更容易地找到我需要的資訊。

## 4. 流程設計

### 4.1 業務流程

1. 使用者點擊登入按鈕，顯示登入對話框
2. 使用者輸入電子郵件和密碼
3. 系統驗證使用者身份
4. 系統根據用戶角色設定相應的權限
5. 系統將用戶重定向到適當的頁面

### 4.2 使用流程

1. 使用者訪問系統首頁
2. 點擊「登入」按鈕
3. 輸入電子郵件和密碼
4. 可選擇「記住我」選項
5. 點擊「登入」提交表單
6. 登入成功後可訪問相應功能
7. 使用完畢後點擊「登出」退出系統

### 4.3 狀態轉換

- 未登入 -> 已登入：使用者成功提供有效的身份憑證
- 已登入 -> 未登入：使用者點擊登出或 Token 過期
- 登入嘗試 -> 登入失敗：提供的身份憑證無效

## 5. 技術設計

### 5.1 架構設計

登入功能基於 Vue 3 + Pinia + Appwrite 架構實現：

- 前端使用 Vue 3 和 Ant Design Vue 構建用戶界面
- 使用 Pinia 進行狀態管理
- 使用 Appwrite 提供身份驗證服務
- 使用 JWT Token 實現身份驗證和授權

### 5.2 數據模型

```
// 用戶個人資料
userProfile: {
  userID: String,      // 用戶 ID
  userName: String,    // 用戶名稱
  userEmail: String,   // 用戶電子郵件
  userTel: String,     // 用戶電話
  userType: Number,    // 用戶角色類型
  userStatus: Number,  // 用戶狀態
}

// 用戶角色枚舉
UserRole: {
  Admin: 1,
  Manager: 2,
  Teacher: 3,
  Student: 4,
}
```

### 5.3 API 設計

#### 5.3.1 API 端點

| 方法 | 路徑           | 描述         | 參數                                       | 返回值                                    |
| ---- | -------------- | ------------ | ------------------------------------------ | ----------------------------------------- |
| POST | `/token`       | 用戶登入     | `hashedValue`: 使用 SHA-256 雜湊的用戶憑證 | 含有 access_token 和 refresh_token 的對象 |
| GET  | `/userprofile` | 獲取用戶資料 | 無 (從 token 中識別用戶)                   | 用戶個人資料                              |

#### 5.3.2 數據流

1. 客戶端通過 HTTPS 發送包含雜湊處理過的認證信息到服務器
2. 服務器驗證憑證並返回包含 token 的響應
3. 客戶端使用 token 請求用戶個人資料
4. 服務器返回用戶資料，客戶端更新本地狀態

### 5.4 依賴關係

- 依賴 `@/appwrite` 和 Appwrite SDK 提供認證服務
- 依賴 `@/utils/axios` 進行 API 通信
- 依賴 `@/utils/misc` 中的 `sha256` 函數進行密碼雜湊
- 依賴 Pinia 進行狀態管理
- 依賴 Vue Router 進行基於角色的路由保護

## 6. UI/UX 設計

### 6.1 頁面設計

- 使用彈出式對話框 (Modal) 實現登入界面
- 採用簡潔的表單設計，包含電子郵件和密碼輸入框
- 提供「記住我」選項和「忘記密碼」鏈接

### 6.2 交互設計

- 表單輸入實時驗證，提供即時反饋
- 登入按鈕在表單無效時禁用
- 登入過程中顯示載入狀態
- 登入成功或失敗時顯示相應的提示訊息

### 6.3 頁面元素

- 電子郵件輸入框，帶有信封圖標
- 密碼輸入框，帶有鎖圖標和顯示/隱藏密碼功能
- 「記住我」複選框
- 「忘記密碼」鏈接
- 登入按鈕，顯示適當的載入狀態

## 7. 測試計劃

### 7.1 測試策略

- 單元測試：驗證各組件功能的正確性
- 整合測試：驗證登入流程的完整性
- 端到端測試：模擬用戶登入流程
- 手動測試：確保 UI/UX 符合設計要求

### 7.2 測試案例

| 測試 ID | 測試描述       | 測試步驟                                           | 期望結果                                       | 前置條件               |
| ------- | -------------- | -------------------------------------------------- | ---------------------------------------------- | ---------------------- |
| TC001   | 有效登入測試   | 1. 輸入有效的電子郵件和密碼<br>2. 點擊登入按鈕     | 登入成功，重定向到適當頁面                     | 用戶帳號存在且有效     |
| TC002   | 無效登入測試   | 1. 輸入無效的電子郵件或密碼<br>2. 點擊登入按鈕     | 顯示登入失敗錯誤訊息                           | 無                     |
| TC003   | 登出測試       | 1. 登入系統<br>2. 點擊登出按鈕                     | 成功登出，所有會話資訊被清除，重定向到登入頁面 | 用戶已登入             |
| TC004   | 權限控制測試   | 1. 以不同角色登入<br>2. 嘗試訪問受限制的功能       | 適當角色可以訪問對應功能，其他角色被拒絕訪問   | 具有不同角色的用戶帳號 |
| TC005   | 記住我功能測試 | 1. 登入時勾選「記住我」<br>2. 關閉瀏覽器並重新開啟 | 用戶保持登入狀態                               | 用戶帳號存在且有效     |

## 8. 開發計劃

### 8.1 工作拆分

| 任務             | 估算時間 | 負責人   |
| ---------------- | -------- | -------- |
| 設計登入界面     | 已完成   | 開發團隊 |
| 實現前端登入邏輯 | 已完成   | 開發團隊 |
| 實現狀態管理     | 已完成   | 開發團隊 |
| 實現權限控制     | 已完成   | 開發團隊 |
| 實現登出功能     | 已完成   | 開發團隊 |
| 測試和調整       | 已完成   | 開發團隊 |

### 8.2 里程碑

| 日期   | 里程碑         |
| ------ | -------------- |
| 已完成 | 完成登入功能   |
| 已完成 | 完成權限控制   |
| 已完成 | 完成測試和調整 |

## 9. 狀態追蹤

### 9.1 開發進度

登入功能已完成並整合到系統中。

### 9.2 問題記錄

| 日期 | 問題描述 | 狀態 | 解決方案 |
| ---- | -------- | ---- | -------- |
| -    | -        | -    | -        |

## 10. 備註

- 系統目前支援兩種登入機制：一種是基於 Appwrite 的原生身份驗證，另一種是自定義的 JWT 令牌系統。
- 目前實現了基本的「忘記密碼」UI，但功能尚未實現。
- MSW (Mock Service Worker) 用於在開發環境中模擬 API 響應。
