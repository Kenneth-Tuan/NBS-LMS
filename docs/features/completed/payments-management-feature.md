# F011 - 支付管理功能

**狀態:** 已完成  
**優先級:** 高  
**預計完成日期:** 已完成  
**負責人:** 開發團隊

## 1. 功能概述

支付管理功能提供了一個全面的解決方案，用於處理學生的學費和其他費用支付。系統支持多種付款方式，生成收據，處理退款和分期付款，並提供付款歷史記錄和報告功能。該功能幫助財務人員管理收入流，確保準確的財務記錄，同時為學生提供便捷的支付體驗。

## 2. 需求規格

### 2.1 功能需求

- 支持多種支付方式（信用卡、銀行轉賬、現金等）
- 生成和管理收據與發票
- 分期付款與自動繳費計劃功能
- 付款提醒和逾期通知
- 學費和其他費用的調整功能
- 退款處理功能
- 收入報告和分析功能
- 與課程註冊系統整合
- 學生付款歷史記錄
- 年度財務報表生成
- 收據和發票 PDF 生成與下載

### 2.2 相關需求文檔

- 支付流程實現在 `src/views/Payments/PaymentProcess.vue`
- 支付歷史頁面在 `src/views/Payments/PaymentHistory.vue`
- 支付管理頁面在 `src/views/Payments/PaymentManagement.vue`
- 支付數據和狀態管理在 `src/stores/payment.js`
- 模擬數據和處理邏輯在 `src/mocks/domains/payments/`

## 3. 使用者故事

**作為** 神學院學生，  
**我希望** 能夠方便地在線支付學費和其他費用，  
**以便** 不必親自到校辦理支付手續。

**作為** 財務管理人員，  
**我希望** 能夠查看和管理所有學生的付款記錄，  
**以便** 確保所有費用都已按時收取並準確記錄。

**作為** 家長或經濟支持者，  
**我希望** 能夠代學生支付費用並獲取收據，  
**以便** 維護財務記錄和報稅。

**作為** 財務主管，  
**我希望** 獲得準確的收入報告和分析，  
**以便** 做出明智的財務決策和預算規劃。

**作為** 學生，  
**我希望** 能夠設定分期付款計劃，  
**以便** 更好地管理我的財務負擔。

## 4. 流程設計

### 4.1 業務流程

1. 產生學生應付費用（註冊課程或其他收費項目）
2. 通知學生支付費用
3. 學生選擇支付方式並完成支付
4. 系統驗證支付並更新付款狀態
5. 生成並發送電子收據
6. 財務人員審核和確認支付
7. 更新學生付款記錄
8. 生成財務報表與分析數據

### 4.2 使用流程

**學生支付流程：**

1. 登入系統查看應付費用
2. 選擇要支付的項目和金額
3. 選擇支付方式（信用卡、銀行轉賬等）
4. 完成支付並獲取收據
5. 查看付款歷史記錄

**財務人員管理流程：**

1. 登入系統進入支付管理頁面
2. 查看待處理支付和付款歷史
3. 處理特殊付款請求（如退款）
4. 生成和導出財務報表
5. 處理付款異常和調整

### 4.3 狀態轉換

- 待支付 -> 處理中：學生發起支付
- 處理中 -> 已完成：支付成功處理
- 處理中 -> 失敗：支付處理失敗
- 已完成 -> 退款中：發起退款請求
- 退款中 -> 已退款：完成退款處理
- 待支付 -> 逾期：付款截止日過期
- 逾期 -> 已支付：延遲付款完成

## 5. 技術設計

### 5.1 架構設計

支付管理功能基於 Vue 3 + Pinia 實現：

- 前端使用 Vue 3 和 Ant Design Vue 構建界面
- 使用 Pinia 進行支付數據和狀態管理
- 使用 Vue Router 處理頁面導航和參數
- 使用表格組件展示支付記錄和狀態
- 使用圖表組件展示財務分析
- 使用 PDF.js 生成收據和發票文件
- 使用 sessionStorage 在測試環境中暫存支付數據

### 5.2 數據模型

```
// 支付項目數據模型
paymentItem: {
  id: String,               // 支付項目ID
  type: String,             // 項目類型（學費、住宿費、活動費等）
  description: String,      // 描述
  amount: Number,           // 金額
  dueDate: Date,            // 截止日期
  term: String,             // 學期
  status: String,           // 狀態（待支付、已支付、逾期等）
  createdAt: Date,          // 創建時間
  updatedAt: Date           // 更新時間
}

// 支付記錄數據模型
paymentRecord: {
  id: String,               // 支付記錄ID
  studentId: String,        // 學生ID
  items: [                  // 支付項目列表
    {
      itemId: String,       // 支付項目ID
      amount: Number        // 實付金額
    }
  ],
  paymentMethod: String,    // 支付方式
  totalAmount: Number,      // 總金額
  transactionId: String,    // 交易ID
  status: String,           // 狀態（處理中、成功、失敗等）
  paymentDate: Date,        // 支付日期
  receiptNumber: String,    // 收據編號
  notes: String,            // 備註
  processedBy: String,      // 處理人
  createdAt: Date,          // 創建時間
  updatedAt: Date           // 更新時間
}

// 分期付款計劃數據模型
installmentPlan: {
  id: String,               // 計劃ID
  studentId: String,        // 學生ID
  originalAmount: Number,   // 原始總金額
  installments: [           // 分期列表
    {
      id: String,           // 分期ID
      dueDate: Date,        // 截止日期
      amount: Number,       // 分期金額
      status: String,       // 狀態
      paymentRecordId: String // 關聯的支付記錄ID
    }
  ],
  status: String,           // 計劃狀態
  createdAt: Date,          // 創建時間
  updatedAt: Date           // 更新時間
}

// 退款記錄數據模型
refundRecord: {
  id: String,               // 退款記錄ID
  paymentRecordId: String,  // 關聯的支付記錄ID
  amount: Number,           // 退款金額
  reason: String,           // 退款原因
  status: String,           // 狀態
  processedBy: String,      // 處理人
  processedDate: Date,      // 處理日期
  notes: String,            // 備註
  createdAt: Date,          // 創建時間
  updatedAt: Date           // 更新時間
}
```

### 5.3 API 設計

在目前實現中，前端使用模擬數據，未來可擴展為以下 API：

| 方法 | 路徑                            | 描述                 | 參數                        | 返回值           |
| ---- | ------------------------------- | -------------------- | --------------------------- | ---------------- |
| GET  | `/payments/items/:studentId`    | 獲取學生待付款項目   | studentId, term             | 待付款項目列表   |
| GET  | `/payments/history/:studentId`  | 獲取學生支付歷史     | studentId, filters          | 支付歷史記錄列表 |
| POST | `/payments/process`             | 處理新的支付請求     | paymentRequestObject        | 支付處理結果     |
| GET  | `/payments/receipt/:paymentId`  | 獲取支付收據         | paymentId                   | 收據數據         |
| POST | `/payments/refund`              | 處理退款請求         | refundRequestObject         | 退款處理結果     |
| POST | `/payments/installment`         | 創建分期付款計劃     | installmentPlanObject       | 分期計劃結果     |
| GET  | `/payments/installment/:planId` | 獲取分期付款計劃詳情 | planId                      | 分期計劃詳情     |
| PUT  | `/payments/status/:paymentId`   | 更新支付狀態         | paymentId, newStatus        | 更新結果         |
| GET  | `/payments/reports/summary`     | 獲取付款摘要報告     | startDate, endDate, filters | 報告數據         |
| GET  | `/payments/reports/outstanding` | 獲取未付款報告       | filters                     | 未付款報告數據   |

### 5.4 依賴關係

- 依賴 `src/stores/payment.js` 進行支付數據管理
- 依賴 `src/stores/student.js` 獲取學生資訊
- 依賴 `src/stores/course.js` 獲取課程相關費用資訊
- 依賴 Ant Design Vue 提供表格、表單和圖表組件
- 依賴 `src/mocks/domains/payments/` 提供模擬數據和處理邏輯
- 依賴 `src/utils/pdfUtils.js` 生成 PDF 收據和發票
- 依賴 `src/utils/currencyUtils.js` 處理金額計算和格式化

## 6. UI/UX 設計

### 6.1 頁面設計

- 學生支付頁面布局：

  - 待付款項目卡片列表
  - 支付方式選擇區域
  - 付款詳情確認區
  - 支付成功/失敗提示

- 學生付款歷史頁面：

  - 付款歷史表格
  - 收據查看和下載區域
  - 付款統計和總額顯示
  - 分期付款計劃展示

- 管理員支付管理頁面：
  - 待處理支付請求頁
  - 付款歷史管理頁
  - 退款處理頁
  - 財務報表和分析頁

### 6.2 交互設計

- 學生支付頁面：

  - 可選擇多個待付款項目一次性支付
  - 支持保存支付方式以便將來使用
  - 分期付款選項與計算器
  - 實時顯示支付處理進度
  - 支付成功後自動發送收據郵件

- 管理員支付管理頁面：
  - 支付記錄多條件過濾和搜索
  - 批量處理支付請求
  - 可調整付款日期和金額
  - 生成和導出各類財務報表
  - 支付異常標記和處理工具

### 6.3 頁面元素

- 支付方式選擇器（信用卡、銀行轉賬等）
- 付款項目卡片和選擇器
- 支付詳情表單和確認面板
- 付款進度指示器
- 收據生成和下載按鈕
- 付款歷史表格與過濾器
- 財務報表圖表和數據表
- 分期付款計算器和計劃表
- 狀態標籤和通知提示
- 導出和打印按鈕

## 7. 測試計劃

### 7.1 測試策略

- 前端支付流程測試：確保支付流程順暢和用戶體驗良好
- 數據驗證測試：確保支付金額和信息準確性
- 支付狀態測試：驗證各種支付狀態轉換的正確性
- 收據生成測試：確保收據生成和 PDF 下載功能正常
- 付款歷史記錄測試：驗證支付記錄的準確性和完整性
- 分期付款邏輯測試：確保分期付款計劃計算和管理正確
- 報表生成測試：驗證財務報表數據計算準確性
- 狀態管理測試：確保 Pinia store 正確處理支付數據
- 易用性測試：確保支付界面易於使用並提供清晰指導

### 7.2 測試案例

| 測試 ID | 測試描述         | 測試步驟                                              | 期望結果                         | 前置條件             |
| ------- | ---------------- | ----------------------------------------------------- | -------------------------------- | -------------------- |
| TC001   | 基本支付流程測試 | 1. 選擇待付款項目<br>2. 選擇支付方式<br>3. 提交支付   | 支付成功處理並生成收據           | 學生有待付款項目     |
| TC002   | 收據生成測試     | 1. 完成支付<br>2. 查看並下載收據                      | 收據成功生成並可下載 PDF 格式    | 已完成支付處理       |
| TC003   | 分期付款計劃測試 | 1. 選擇分期支付選項<br>2. 設置分期參數<br>3. 提交計劃 | 成功創建分期計劃並顯示付款時間表 | 支持分期付款的項目   |
| TC004   | 退款處理測試     | 1. 選擇已付款項<br>2. 申請退款<br>3. 提交退款原因     | 退款請求成功提交並處理           | 已完成且可退款的支付 |
| TC005   | 財務報表生成測試 | 1. 設置報表參數<br>2. 生成報表<br>3. 導出報表         | 報表數據準確並可成功導出         | 有足夠的支付數據     |
| TC006   | 支付狀態管理測試 | 1. 模擬不同支付狀態<br>2. 測試狀態轉換<br>3. 檢查通知 | 支付狀態正確轉換並發送相應通知   | 各種狀態的支付記錄   |

## 8. 開發計劃

### 8.1 工作拆分

| 任務                    | 估算時間 | 負責人   |
| ----------------------- | -------- | -------- |
| 支付流程界面設計實現    | 已完成   | 開發團隊 |
| 付款狀態與記錄管理功能  | 已完成   | 開發團隊 |
| 收據生成與 PDF 導出功能 | 已完成   | 開發團隊 |
| 分期付款計劃實現        | 已完成   | 開發團隊 |
| 退款處理功能            | 已完成   | 開發團隊 |
| 財務報表和分析功能      | 已完成   | 開發團隊 |
| 支付歷史和管理界面      | 已完成   | 開發團隊 |
| 付款提醒和通知功能      | 已完成   | 開發團隊 |
| 整體功能測試            | 已完成   | 開發團隊 |

### 8.2 里程碑

| 日期   | 里程碑                 |
| ------ | ---------------------- |
| 已完成 | 基本支付功能和界面     |
| 已完成 | 支付狀態管理和記錄功能 |
| 已完成 | 收據生成和付款歷史功能 |
| 已完成 | 分期付款和退款處理功能 |
| 已完成 | 財務報表和分析功能     |
| 已完成 | 整合測試和功能完善     |

## 9. 狀態追蹤

### 9.1 開發進度

支付管理功能已完成並整合到系統中。

### 9.2 問題記錄

| 日期 | 問題描述 | 狀態 | 解決方案 |
| ---- | -------- | ---- | -------- |
| -    | -        | -    | -        |

## 10. 備註

- 目前支付處理使用模擬數據，實際上線後需要整合真實支付網關 API
- 未來可考慮實現自動對賬和財務核銷功能
- 可增加更多支付方式，如移動支付、電子錢包等
- 考慮增加財務審計日誌功能，追蹤所有財務操作
- 可實現財務預算管理和對比分析功能
- 考慮增加批量支付和批量發送收據功能
- 未來可加強與會計系統的整合，實現財務數據自動同步
